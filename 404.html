
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="utf-8">
    <title>My Spotify Debug</title>
</head>
<body>
    <h1>Spotify Debug</h1>
    
    <div id="debug" style="background: #f0f0f0; padding: 15px; margin: 10px 0;">
        <h3>Debug Info:</h3>
        <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>Search params:</strong> <span id="searchParams"></span></p>
        <p><strong>Hash:</strong> <span id="hashInfo"></span></p>
        <p><strong>Code parameter:</strong> <span id="codeParam"></span></p>
        <p><strong>Script status:</strong> <span id="scriptStatus">Loading...</span></p>
    </div>

    <div id="status" style="padding: 10px; margin: 10px 0; border: 1px solid #ccc;">
        <p>Status: <span id="currentStatus">Initializing...</span></p>
    </div>

    <button onclick="testAuth()" style="padding: 10px 20px; font-size: 16px;">
        Test Spotify Login
    </button>

    <div id="profile" style="margin-top: 20px;">
        <h2>Profile Info:</h2>
        <p>Display Name: <span id="displayName">-</span></p>
        <p>ID: <span id="id">-</span></p>
        <p>Email: <span id="email">-</span></p>
        <div id="avatar"></div>
    </div>

    <script>
        console.log("=== SCRIPT STARTING ===");
        
        // Debug info
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('searchParams').textContent = window.location.search || "(empty)";
        document.getElementById('hashInfo').textContent = window.location.hash || "(empty)";
        document.getElementById('scriptStatus').textContent = "Loaded!";
        
        const clientId = "ec7fe00bdec6414f98e858b395175584";
        
        // Check for code parameter
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const error = params.get("error");
        
        document.getElementById('codeParam').textContent = code || "(none)";
        
        console.log("Client ID:", clientId);
        console.log("Code:", code);
        console.log("Error:", error);
        
        if (error) {
            document.getElementById('currentStatus').textContent = "Error from Spotify: " + error;
            console.error("Spotify error:", error);
        } else if (code) {
            document.getElementById('currentStatus').textContent = "Code received, processing...";
            console.log("Code found, processing...");
            processSpotifyCallback(code);
        } else {
            document.getElementById('currentStatus').textContent = "Ready for login";
            console.log("No code found, ready for auth");
        }

        function testAuth() {
            console.log("=== STARTING AUTH ===");
            document.getElementById('currentStatus').textContent = "Starting authentication...";
            redirectToSpotify();
        }

        function redirectToSpotify() {
            try {
                console.log("Generating verifier...");
                const verifier = generateCodeVerifier(128);
                console.log("Verifier:", verifier);
                
                localStorage.setItem("verifier", verifier);
                console.log("Verifier saved to localStorage");
                
                generateCodeChallenge(verifier).then(challenge => {
                    console.log("Challenge:", challenge);
                    
                    const params = new URLSearchParams();
                    params.append("client_id", clientId);
                    params.append("response_type", "code");
                    params.append("redirect_uri", "https://jatavena.github.io/MySpotify/");
                    params.append("scope", "user-read-private user-read-email");
                    params.append("code_challenge_method", "S256");
                    params.append("code_challenge", challenge);

                    const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
                    console.log("Auth URL:", authUrl);
                    
                    document.getElementById('currentStatus').textContent = "Redirecting to Spotify...";
                    
                    // Give user time to see the status
                    setTimeout(() => {
                        window.location.href = authUrl;
                    }, 1000);
                });
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('currentStatus').textContent = "Auth error: " + error.message;
            }
        }

        async function processSpotifyCallback(code) {
            try {
                console.log("=== PROCESSING CALLBACK ===");
                
                const verifier = localStorage.getItem("verifier");
                console.log("Retrieved verifier:", verifier ? "Found" : "NOT FOUND");
                
                if (!verifier) {
                    throw new Error("Code verifier not found");
                }

                document.getElementById('currentStatus').textContent = "Getting access token...";
                
                const params = new URLSearchParams();
                params.append("client_id", clientId);
                params.append("grant_type", "authorization_code");
                params.append("code", code);
                params.append("redirect_uri", "https://jatavena.github.io/MySpotify/");
                params.append("code_verifier", verifier);

                console.log("Making token request...");
                const result = await fetch("https://accounts.spotify.com/api/token", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: params
                });

                console.log("Token response status:", result.status);
                
                if (!result.ok) {
                    const errorText = await result.text();
                    console.error("Token error:", errorText);
                    throw new Error(`Token request failed: ${result.status}`);
                }

                const data = await result.json();
                console.log("Token received!");
                
                localStorage.removeItem("verifier");
                
                document.getElementById('currentStatus').textContent = "Getting profile...";
                
                const profileResult = await fetch("https://api.spotify.com/v1/me", {
                    method: "GET",
                    headers: { Authorization: `Bearer ${data.access_token}` }
                });

                console.log("Profile response status:", profileResult.status);
                
                if (!profileResult.ok) {
                    throw new Error(`Profile request failed: ${profileResult.status}`);
                }

                const profile = await profileResult.json();
                console.log("Profile:", profile);
                
                document.getElementById('currentStatus').textContent = "Success!";
                document.getElementById('displayName').textContent = profile.display_name || 'N/A';
                document.getElementById('id').textContent = profile.id || 'N/A';
                document.getElementById('email').textContent = profile.email || 'N/A';
                
                if (profile.images && profile.images[0]) {
                    const img = document.createElement('img');
                    img.src = profile.images[0].url;
                    img.width = 100;
                    img.height = 100;
                    document.getElementById('avatar').appendChild(img);
                }
                
            } catch (error) {
                console.error("Callback error:", error);
                document.getElementById('currentStatus').textContent = "Error: " + error.message;
            }
        }

        function generateCodeVerifier(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        console.log("=== SCRIPT READY ===");
    </script>
</body>
</html>